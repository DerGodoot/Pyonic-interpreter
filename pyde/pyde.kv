#:import Clock kivy.clock.Clock
#:import FocusBehavior kivy.uix.behaviors.FocusBehavior
#:import Window kivy.core.window.Window

<Label>:
    color: 0, 0, 0, 1

<Manager>:
    # HomeScreen:
    InterpreterScreen:


<HomeScreen>:
    name: 'home'
    BoxLayout:
        orientation: 'vertical'
        HeightLabel:
            size_hint_y: None
            height: sp(80)
            font_size: sp(40)
            text: 'PyDE'
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
        HomeScreenButton:
            text: 'interpreter'
            on_press: root.manager.open_interpreter()
        HomeScreenButton:
            text: 'file'
        Widget:

<InterpreterScreen>:
    name: 'interpreter'
    BoxLayout:
        orientation: 'vertical'
        # BoxLayout:
        #     size_hint_y: None
        #     height: sp(60)
        #     Button:
        #         text: 'back'
        #         width: 2*self.texture_size[0]
        #         size_hint_x: None
        #         color: 1, 1, 1, 1
        #         on_press: root.manager.go_back()
        #     Widget:
        InterpreterGui:
    
<HeightButton>:
    size_hint_y: None

<HomeScreenButton>:
    color: 1, 1, 1, 1

<InterpreterGui>:
    output_window: output_window
    code_input: input
    scrollview: scrollview
    orientation: 'vertical'
    canvas:
        Color:
            rgba: 0.9, 0.9, 0.9, 1
        Rectangle:
            pos: self.pos
            size: self.size
    FloatLayout:
        ScrollView:
            pos_hint: {'x': 0, 'y': 0}
            id: scrollview
            bar_width: dp(10)
            GridLayout:
                height: max(scrollview.height, self.minimum_height)
                size_hint_y: None
                cols: 1
                id: output_window
                canvas.before:
                    Color:
                        rgba: 0.55, 0.55, 0.55, 0.55
                    Rectangle:
                        pos: self.pos
                        size: self.size
                    Color:
                        rgba: 0, 0, 0, 1
                    Line:
                        rectangle: [self.x, self.y, self.width, self.height]
                Widget:
                    size_hint_y: None
                    height: dp(40)
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(40)
            pos_hint: {'top': 1}
            canvas:
                Color:
                    rgba: 0.5, 0.5, 0.5, 0.8
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                size_hint_x: None
                width: self.texture_size[0]
                padding_x: dp(10)
                pos_hint: {'top': 1}
                markup: True
                text: 'status: [b][color=#{}]{}[/color][/b]'.format(root.status_label_colour, root.interpreter_state.replace('_', ' '))
            Widget:
            Button:
                text: 'RESTART'
                size_hint_x: None
                width: 1.8 * self.texture_size[0]
                background_color: 1, 0, 0, 1
                # on_release: root.restart_interpreter()
                on_release: root.query_restart()
                color: 1, 1, 1, 1
                # disabled: True if root.interpreter_state != 'not_responding' else False
                # opacity: 0.2 if root.interpreter_state != 'not_responding' else 1
            Widget:
                size_hint_x: None
                width: dp(30)
            Button:
                text: 'CTRL + C'
                size_hint_x: None
                width: 1.8 * self.texture_size[0]
                background_color: 0.2, 0.7, 1, 1
                on_release: root.send_sigint()
                color: 1, 1, 1, 1
                disabled: True if root.interpreter_state in ('waiting', 'restarting') else False
                opacity: 0.2 if root.interpreter_state in ('waiting', 'restarting') else 1
    Widget:
        size_hint_y: None
        height: dp(2)
        canvas:
            Color:
                rgba: 0.3, 0.3, 0.3, 1
            Rectangle:
                pos: self.pos
                size: self.size
    BoxLayout:
        size_hint_y: None
        height: sp(100)
        MonoLabel:
            text: '>>>'
            width: self.texture_size[0] * 1.5
            size_hint_x: None
        InterpreterInput:
            id: input
            root: root
            disabled: root._lock_input
            font_name: 'RobotoMono-Regular.ttf'
            canvas.after:
                Color:
                    rgba: 1, 0, 0, root.input_fail_alpha
                Rectangle:
                    pos: self.pos
                    size: self.size
        NonDefocusingButton:
            text: 'N'
            font_name: 'assets/fontello.ttf'
            font_size: sp(20)
            width: self.texture_size[0] * 3
            size_hint_x: None
            on_release: root.interpret_line_from_code_input()
    BoxLayout:
        size_hint_y: None
        height: sp(40)
        orientation: 'horizontal'
        # NonDefocusingButton:
        #     size_hint_x: 4
        #     text: 'previous line'
        #     disabled: True if root.browsing_previous_lines == 'no' else False
        #     on_press: root.insert_previous_line()
        NonDefocusingButton:
            text: '='
            font_name: 'RobotoMono-Regular.ttf'
            on_press: input.insert_text('=')
        NonDefocusingButton:
            text: '('
            font_name: 'RobotoMono-Regular.ttf'
            on_press: input.insert_text('(')
        NonDefocusingButton:
            text: ')'
            font_name: 'RobotoMono-Regular.ttf'
            on_press: input.insert_text(')')
        NonDefocusingButton:
            text: ':'
            font_name: 'RobotoMono-Regular.ttf'
            on_press: input.insert_text(':')
        NonDefocusingButton:
            text: 'h'
            font_name: 'assets/fontello.ttf'
            on_press: input.do_cursor_movement('cursor_left')
        NonDefocusingButton:
            text: 'n'
            font_name: 'assets/fontello.ttf'
            on_press: input.do_cursor_movement('cursor_down')
        NonDefocusingButton:
            text: 'e'
            font_name: 'assets/fontello.ttf'
            on_press: input.do_cursor_movement('cursor_up')
        NonDefocusingButton:
            text: 'i'
            font_name: 'assets/fontello.ttf'
            on_press: input.do_cursor_movement('cursor_right')
        

<NonDefocusingButton>:
    color: (1, 1, 1, 1)
            
<MonoLabel@Label>:
    font_name: 'RobotoMono-Regular.ttf'

<InputLabel>:
    size_hint_y: None
    height: self.texture_size[1] + dp(20)
    text_size: self.width, None
    font_name: 'RobotoMono-Regular.ttf'
    padding_x: dp(10)
    canvas.before:
        Color:
            rgba: 0.85 - self.blue_shift * 0.3, 0.85 - self.blue_shift * 0.3, 0.9 + self.blue_shift * 0.1, 0.95
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: 0, 0, 0, 1
        Line:
            rectangle: [self.x, self.y, self.width, self.height]
        Color:
            rgba: (0.65, 0.65, 0.95, 1)
        Rectangle:
            pos: self.pos
            size: dp(5), self.height

<OutputLabel>:
    size_hint_y: None
    height: self.texture_size[1] + dp(2)
    text_size: self.width, None
    font_name: 'RobotoMono-Regular.ttf'
    padding_x: dp(10)
    canvas.before:
        Color:
            rgba: 0.95, 0.95, 0.95, 0.95
        Rectangle:
            pos: self.pos
            size: self.size
        Color:
            rgba: (0.65, 0.95, 0.65, 1) if self.stream == 'stdout' else (0.95, 0.65, 0.65, 1)
        Rectangle:
            pos: self.pos
            size: dp(5), self.height

<NotificationLabel>:
    size_hint_y: None
    height: self.texture_size[1] + dp(8)
    markup: True
    color: 1, 1, 1, 1
    canvas.before:
        Color:
            rgba: root.background_colour
        Rectangle:
            pos: self.pos
            size: self.size
        

<BreakMarker>:
    size_hint_y: None
    height: dp(2)
    canvas:
        Color:
            rgba: 0.3, 0, 0, 1
        Rectangle:
            pos: self.pos
            size: self.size

<RestartPopup>:
    size_hint_x: None
    size_hint_y: None
    width: min(0.8*Window.width, dp(350))
    vertical_padding: dp(20)
    height: gridlayout.height
    GridLayout:
        id: gridlayout
        height: self.minimum_height
        cols: 1
        Widget:
            size_hint_y: None
            height: root.vertical_padding
        Label:
            text: 'Are you sure you want to restart the interpreter? Your variable context will be lost.'
            text_size: self.width, None
            halign: 'center'
            color: 1, 1, 1, 1
            size_hint_y: None
            height: self.texture_size[1]
            padding_x: dp(20)
            padding_y: dp(20)
        Widget:
            size_hint_y: None
            height: root.vertical_padding
        BoxLayout:
            size_hint_y: None
            height: dp(40)
            Widget:
                size_hint_x: 0.2
            Button:
                text: 'cancel'
                color: 1, 1, 1, 1
                on_release: root.dismiss()
                background_color: 1, 0, 0, 1
            Widget:
                size_hint_x: 0.2
            Button:
                text: 'restart'
                color: 1, 1, 1, 1
                on_release: root.interpreter_gui.restart_interpreter(); root.dismiss()
                background_color: 0, 0.8, 0, 1
            Widget:
                size_hint_x: 0.2
        Widget:
            size_hint_y: None
            height: root.vertical_padding
            